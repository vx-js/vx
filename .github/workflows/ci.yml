name: CI

on:
  push:
    branches: [master]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

jobs:
  release:
    name: Release
    needs: build
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*

  canary-version:
    name: Canary version
    if: (github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.compute.outputs.version }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Compute canary version
        id: compute
        run: node scripts/ci/compute-canary-version.js

  publish-npm-platform:
    name: Publish npm platform packages (${{ matrix.name }})
    needs: build
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: windows-x64
            os: windows-latest
            pkgdir: npm/vx-win32-x64-msvc
            rustTarget: x86_64-pc-windows-msvc
          - name: linux-x64
            os: ubuntu-latest
            pkgdir: npm/vx-linux-x64-gnu
            rustTarget: x86_64-unknown-linux-gnu
          - name: linux-arm64
            os: ubuntu-latest
            pkgdir: npm/vx-linux-arm64-gnu
            rustTarget: aarch64-unknown-linux-gnu
          - name: macos-x64
            os: macos-15-intel
            pkgdir: npm/vx-darwin-x64
            rustTarget: x86_64-apple-darwin
          - name: macos-arm64
            os: macos-latest
            pkgdir: npm/vx-darwin-arm64
            rustTarget: aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org/

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rustTarget }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install Linux cross toolchain
        if: matrix.rustTarget == 'aarch64-unknown-linux-gnu'
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Configure Linux cross linker
        if: matrix.rustTarget == 'aarch64-unknown-linux-gnu'
        run: echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Publish
        working-directory: ${{ matrix.pkgdir }}
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-npm-wrapper:
    name: Publish npm wrapper package
    needs: publish-npm-platform
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org/

      - name: Publish @vx-js/vx
        working-directory: npm/vx
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-npm-platform-canary:
    name: Publish npm platform packages canary (${{ matrix.name }})
    needs: canary-version
    if: >-
      ((github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'workflow_dispatch')
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: windows-x64
            os: windows-latest
            pkgdir: npm/vx-win32-x64-msvc
            rustTarget: x86_64-pc-windows-msvc
          - name: linux-x64
            os: ubuntu-latest
            pkgdir: npm/vx-linux-x64-gnu
            rustTarget: x86_64-unknown-linux-gnu
          - name: linux-arm64
            os: ubuntu-latest
            pkgdir: npm/vx-linux-arm64-gnu
            rustTarget: aarch64-unknown-linux-gnu
          - name: macos-x64
            os: macos-15-intel
            pkgdir: npm/vx-darwin-x64
            rustTarget: x86_64-apple-darwin
          - name: macos-arm64
            os: macos-latest
            pkgdir: npm/vx-darwin-arm64
            rustTarget: aarch64-apple-darwin

    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org/

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rustTarget }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install Linux cross toolchain
        if: matrix.rustTarget == 'aarch64-unknown-linux-gnu'
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Configure Linux cross linker
        if: matrix.rustTarget == 'aarch64-unknown-linux-gnu'
        run: echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Set canary version
        working-directory: ${{ matrix.pkgdir }}
        env:
          CANARY_VERSION: ${{ needs.canary-version.outputs.version }}
        run: node ../../scripts/ci/set-canary-version.js

      - name: Publish (canary)
        working-directory: ${{ matrix.pkgdir }}
        run: npm publish --tag canary
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-npm-wrapper-canary:
    name: Publish npm wrapper package canary
    needs:
      - canary-version
      - publish-npm-platform-canary
    if: >-
      ((github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org/

      - name: Set canary version (and optionalDependencies)
        working-directory: npm/vx
        env:
          CANARY_VERSION: ${{ needs.canary-version.outputs.version }}
        run: node ../../scripts/ci/set-canary-version-with-deps.js

      - name: Publish @vx-js/vx (canary)
        working-directory: npm/vx
        run: npm publish --tag canary
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
